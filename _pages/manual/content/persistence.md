---
permalink: /manual/persistence
title: "Persistence"
sidebar:
  title: "Manual"
  nav: manual
---

<div class="mxgraph" style="" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;lightbox&quot;:false,&quot;nav&quot;:true,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-03-30T14:36:17.884Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.84 Safari/537.36\&quot; etag=\&quot;FOzjs_JF78TtVRWAPN-t\&quot; version=\&quot;17.2.5\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;fLcR9MZWJoV5Xf4QogHr\&quot; name=\&quot;Persistence\&quot;&gt;7Vzrc6I6FP9r/Ng7vKEfrbp92b3dtb273i+dKFFpgXhDqNq/fgOEBUy0buUhnTvTmZKTQJLfOTmvJHbUnre+xGC5uEM2dDuKZK87ar+jKLKmKJ3oT7I3CcU8NxLCHDs2a5QRRs4bZESJUUPHhkGhIUHIJc6ySJwi34dTUqABjNGq2GyG3GKvSzBnPUoZYTQFLuSa/XBsskiolp5rfQWd+SLtWZZYjQfSxowQLICNVjmSOuioPYwQSZ68dQ+6EXgpLsl7X3bU/h4Yhj455IX+k/1Mnr8uv31/G2Hz/EZZv92cMe68AjdkEx6h0A3YiMkmhWG1cAgcLcE0Kq8oqzvqxYJ4Li3J9BG4ztynz1M6Fogp4RVi4lAUu6yCoOiNGfIJYzEdLC07rttDLsJxJ+rMmsLplNIDgtELzNVMLF3Tozf4STMcog7hOkdiIFxC5EGCN7RJWmswhjCJ1FNerjL+6inTFjneqikRMJma//52Bjt9YMiLuTDoB92/b8L1nQecQAOL3mC1PJM1jg3SR1mAkwEzDFOZlVP02fekHagJsN0JpCbrBSBNhQdSMQRAaiXgKJRmmYOxhzBsRphtAK2ZUJiNqQUns2qEWT0/UJhltQQm3D35Y4S+j1ferWddXYRY2lyd6Rze0KYqlRURJgs0Rz5wBxn1AqPQt6EdC6Z6kbUZogjqmCvPkJANwxuEBBV5BtcO+Zl7Hkef+ktnpf6afTkubFhhJ/wBCvEU7pliaogAnkOypx3TrtH89zITQxcQ57VockpnDL867iEOnIBAf0rl0yfA8am8H7taiopH2VI8u7TMnwi9qhcVj6byQi9rFSkeMbRKW4Seoo43P/OF3FtRMXstLh2/WJQDF0vq8Z3IahF4RuC19OWxwy4ftTx0tWgTml8eWltWx8elXD1Uyk9KyNWdJqENgi6bpyboJodnF0PQRijNA6EsIyYSQmlxUN7CTRuRFHjk9SJ53lIkOTevcSRTFyUHZd8JXirHks+UzGaKOFNiGxNDN8oJLk1pW7/qhzGgjNhSGOCrn8qREE5R4x0JYTujKUdi36g/X2ypH6p0KktqtSafUmlouW8NvLtW0vD8RBaLwS8WF2wgvsdw1tYgs/l1YrZlnXxc3q0D5V07KXHnPfl7Z/oSLlsg5dvOfPNSzjvz1NB6wI/m2D48jUMj9jJcerFp4F36+97tU28wHLYRT8FeZs148rsMXfuVzjDEsJyt5foDzxNAVdnjMlQP6YnEn/p5jfHnYgHkF+tStR834EX7IT+aD/+2J5FdqS8uhEawJ3pavsm+UX+SBLhp1eieCPHcpadaCKYlOM5SmdYXginYnRmO24ik1jSS+g6xvPYj1wThNqTDOV+vzlhEiGqjEXdmAce5mvesYWYAxwX7V7Y1FGSm9tmfE7GGfGJqFE6izSK1e/31nxauEbPO+FIIKZ/8uKbyv24Bltz2W51bwkIs+dzHh0/JNhlNNi6Tghi9oxhufGp4CfwCoMZ/YXRA/YJOlpwx9Lq0hQtnpKMkSlKKIDsLYo0d1cnScp29SZ/m0f9iGuBJeoqdGTpHA3gRl+ZJY4mSY2WTDIhOMBmTweoT8gRXNMraOrCd14p6uCbQC3L4xT3V1fm7gvRHX+G5n8iKPwmWyaC2SYm1yr74ZXib/7z0LQQ+cUjUiLrX0siNKrqP8v94JV8cPnzfhZec4bULrerzUNmhe7mk+yCGtaWfFUGWyRToZ1M/Xj+Lr4PwbtgmoIu6HmN31J2QbWMnuhOiC7CUywhShGA2m5E47oKNsgWmwHMQCWZl95SEx0Xr3Hw6Ck5dOjE4+UMzD9BbIgxqyEcUU/o2nIEw1uiIdhGr+76a6dfjYLdODHaFVwnyR/Fu8LadIByr7LadGEeBOmitahVkzusVSuEJuvbq1sbx5FO+dSrXGtRo4wjz2UK/fWpUtMtTsxrlL420Vo1ajdt2wWGzFqvR5vHkc66fS41WiDAtZr/uEdflfiNFHfwC&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>

## Core

Persistence in AAK is built as simple as possible for the consuming components. Therefore we will start exploring persistence from this side and work our way towards the persistence management.  

Most built in components of AAK simply reference a __PersisterBase__ to keep their own persistence logic as slim as possible. That __PersisterBase__ has methods for checking if a value has ever been set, retrieving it, setting it and clearing it out. For example the __ObjectAction__ just calls Set(true) when it is triggered and whenever it is started in the future(scene/game reload) it calls Get<bool>() to check if it has been triggered already.  

Persisters can come in different forms but there is one called __ManualPersister__ that is meant specifically for the case above where some other component needs to save its state. The persister has a field for a key which is needed to identify its data and one for the area. A persister is convenient to keep persistence logic out of game logic but not necessarily needed, the PickupAction for example just deals with persistence itself without using a separate persister.  

Another kind of persister is the __DestructionPersister__ which simply sets a bool when it gets destroyed and destroys its GameObject if that bool has been set in the past. This means you can just add this persister to any destructible object to persist the destruction without any other scripting needed.  

A __PersistenceArea__ is a ScriptableObject found in Adventure/PersistenceArea that groups together data that will be saved together. This can be useful to separate smaller data that is saved frequently from larger data that is saved less frequently. The PersistenceArea also has the IsGlobal flag which is meant for data that is saved independent of save slot(settings for example).  

The __PersistenceContainer__ is the central singleton manager for persistence that is needed in every scene that uses any kind of persistence. This is where all the persistence data is managed and eventually sent to the saver that actually saves it to a storage medium. As you might have guessed from the above ObjectAction example state persistence in AAK is pushed rather than pulled. This means that state is not collected when a save game is created, instead state is sent to the container whenever it changes and the container decides when it actually saves the state. The container can be set to AutoSave so that is saves at the end of the frame whenever anything has changed, otherwise a Save() has to be called by some outside component like a save button.  

In the inspector for __PersistenceContainer__ you can find some useful helper buttons that can be used to deleted data when debugging or to check the keys of the persisters in the scene for duplicates. It can also generate random GUID keys for any persisters with an empty key field. So if you have objects that do not necessarily need a readable key just leave the key in their prefab empty and generate them all before you use the persistence. 

As mentioned above the container does not save to disk itself, instead it references a __PersistenceSaverBase__ for that purpose. This is done so that the 'device-facing' part of persistence is easily replaceable as I anticipate it might have to be customized depending on the built platform and other factors.     

## Souls

State in AdventureSouls is split into a couple different areas. __SoulsSystemPersistence__ is a global area independent of the save slot that is used for settings like the sound effects volume but also to save a short info structure for every save index that is displayed in the title screen. __SoulsPlayerPersistence__ is just used by the player character, the player gets its own area because it is saved quite frequently. The __SoulsPermanentPersistence__ is used to save permanent world state like collected items or pulled levers. Lastly __SoulsTemporaryPersistence__ is where any state resides that is discarded whenever the player changes the level or sits at a bonfire. It contains the state of the enemies and destructible environment objects.  

The __PersistenceContainer__ is part of the SoulsSetup prefab which contains all the necessary setup to run the game. Basically if you create a new scene and add the setup as well as a plane for the player to stand on you can start the game and it'll work. If you check the container on the setups in the debugging scenes like Scenes/Debugging/SoulsDebuggingGeneral you may notice some overrides. For one the key is overridden so that data saved for that debug scene does not override data from the actual game scenes. Also the saver has been removed for most of them, this completely disables persistence because for most debug scenes a complete reset is more useful. If you want to debug the persistence logic you have to reassign or revert that saver. 